# Fish Tank System

This system provides a complete fish tank simulation for your Cocos Creator 3.8.6 game, with Firebase integration for saving and loading fish data.

## Components

### 1. Fish Component (`Fish.ts`)

- Represents an individual fish in the tank
- Handles random movement within tank boundaries
- Can be assigned a sprite for visual representation
- Stores fish data (health, type, feeding time, etc.)

### 2. FishTank Component (`FishTank.ts`)

- Manages multiple fish instances
- Defines tank boundaries using a boundary node
- Spawns fish from saved data
- Handles fish lifecycle (spawn, destroy, etc.)

### 3. FishTankManager Component (`FishTankManager.ts`)

- Bridges the FishTank with the Firebase database
- Uses real-time listeners for automatic fish data updates
- Handles saving fish data to database
- Provides high-level fish management functions

### 4. FriendsFishTankManager Component (`FriendsFishTankManager.ts`)

- Displays friends' fish tanks using their UID
- Integrates with social service to fetch friends' fish data
- Supports fish interaction features (viewing, stealing)
- Provides friend tank management and refresh functionality

### 5. FishTankUI Component (`FishTankUI.ts`)

- Bridges the FishTank with the Firebase database
- Uses real-time listeners for automatic fish data updates
- Handles saving fish data to database
- Provides high-level fish management functions

### 4. FishTankUI Component (`FishTankUI.ts`)

- Provides UI controls for fish tank management
- Buttons for adding, clearing, refreshing, and saving fish
- Displays fish count

## Setup Instructions

### 1. Create Fish Prefab

1. Create a new Node in Cocos Creator
2. Add a Sprite component for the fish visual
3. Add the `Fish` component script to the same node
4. The Fish component will automatically find the Sprite component on the same node
5. Adjust `moveSpeed` and `changeDirectionInterval` as needed
6. Save as a prefab

### 2. Setup Fish Tank Scene

1. Create a tank node (this will be your visual tank boundary)
2. Add a UITransform component to define the tank size
3. Add the `FishTank` component to the same node
4. The FishTank will use its own node's size as the tank boundary
5. Assign the FishManager component to the `fishManager` property
6. Set `maxFishCount` as desired

### 3. Add Fish Tank Manager

1. Create a manager node with the `FishTankManager` component
2. Assign the FishTank component to the `fishTank` property
3. Assign the FishManager component to the `fishManager` property
4. Enable `autoLoadFish` to automatically use real-time listeners for database updates
5. The system now uses Firebase real-time listeners instead of polling

### 4. Setup Friends Fish Tank Manager (Optional)

1. Create a friends tank manager node with the `FriendsFishTankManager` component
2. Assign a separate FishTank component to the `fishTank` property
3. Assign the FishManager component to the `fishManager` property
4. Use `loadFriendsFishTank(friendUid)` to display a friend's fish tank
5. This component is separate from the main tank for viewing friends' tanks

### 5. Optional UI Setup

1. Create UI buttons and labels
2. Add the `FishTankUI` component to a UI node
3. Assign the FishTankManager and UI elements to their respective properties

## Fish Data Structure

Fish data is stored using the `SavedFishType` interface:

```typescript
export type SavedFishType = {
  id?: string; // Auto-generated by Firebase
  ownerId: string; // User ID who owns the fish
  type: string; // Fish type (e.g., "goldfish", "clownfish")
  health: number; // Fish health (0-100)
  lastFedTime: number; // Timestamp of last feeding
};
```

## Usage Examples

### Adding a New Fish

```typescript
// Through FishTankManager
this.fishTankManager.addNewFish("goldfish");

// Directly through FishTank
const fishData: SavedFishType = {
  ownerId: "user123",
  type: "clownfish",
  health: 100,
  lastFedTime: Date.now(),
};
this.fishTank.spawnFish(fishData);
```

### Loading Fish from Database

```typescript
// Real-time loading (if autoLoadFish is enabled) - automatic
// Manual loading
await this.fishTankManager.loadFishFromDatabase();

// Enable/disable real-time updates
this.fishTankManager.enableAutoLoadFish();
this.fishTankManager.disableAutoLoadFish();
```

### Saving Fish to Database

```typescript
await this.fishTankManager.saveFishToDatabase();
```

### Friends Fish Tank Management

```typescript
// Load a friend's fish tank
await this.friendsTankManager.loadFriendsFishTank(friendUid, friendData);

// Get current fish count in friend's tank
const count = this.friendsTankManager.getFishCount();

// Get all fish data for interactions
const fishData = this.friendsTankManager.getCurrentFishData();

// Steal a specific fish from friend
const result = await this.friendsTankManager.stealFish(fishId);
if (result.success) {
  console.log(`Successfully stole fish! Detected: ${result.detected}`);
}

// Check if we can interact with friend's fish
const canInteract = await this.friendsTankManager.canInteractWithFish();

// Refresh the friend's tank
await this.friendsTankManager.refreshFriendsFishTank();

// Clear the tank display
this.friendsTankManager.clearFishTank();
```

## Real-time Database Listeners

The system now uses Firebase real-time listeners for efficient data synchronization instead of polling:

### Database Service Listener Method

```typescript
// Subscribe to real-time fish data updates
const unsubscribe = databaseService.onFishDataChanged((fishData) => {
  if (fishData) {
    console.log("Fish data updated:", fishData);
    // Handle the updated fish data
  }
});

// Clean up listener when done
unsubscribe();
```

### Automatic Updates

When `autoLoadFish` is enabled in `FishTankManager`, the system automatically:

1. Sets up a real-time listener on component start
2. Updates the fish tank whenever database data changes
3. Cleans up the listener when the component is destroyed

### Manual Control

You can control the real-time updates programmatically:

```typescript
// Enable real-time updates
this.fishTankManager.enableAutoLoadFish();

// Disable real-time updates
this.fishTankManager.disableAutoLoadFish();

// Manual refresh (one-time load)
await this.fishTankManager.loadFishFromDatabase();
```

## Firebase Integration

### Required Firebase Services

This system requires Firebase Realtime Database and Authentication services to be configured in your project.

### Database Structure

```
users/
  {uid}/
    fishes/
      {fishId}/
        ownerId: string
        type: string
        health: number
        lastFedTime: number
```

## Benefits of Real-time Listeners

- **Instant Updates**: Changes reflect immediately across all clients
- **Efficient**: Only triggers when data actually changes
- **Automatic Cleanup**: Listeners are properly cleaned up to prevent memory leaks
- **Error Handling**: Robust error handling with automatic fallbacks

## Customization

### Fish Movement

Adjust these properties in the Fish component:

- `moveSpeed`: How fast the fish moves
- `changeDirectionInterval`: How often fish change direction

### Tank Boundaries

The tank boundaries are automatically calculated from the FishTank component's own node size. You can:

- Use a UITransform component for precise size control
- Use node scaling for simpler boundary definition
- The FishTank component references its own node as the tank boundary

### Fish Types

Fish types are stored as strings and can be anything you want:

- "goldfish", "clownfish", "angelfish", etc.
- Use these to load different sprites or apply different behaviors

## Architecture Simplifications

The system has been simplified for better maintainability:

- **Fish Component**: Self-contained movement and boundary detection
- **FishTank Component**: Focuses on tank management and fish spawning
- **FishTankManager**: Simplified to handle only database synchronization and display
- **Database Service**: Exposes Firebase's callback directly for real-time updates
- **No Fish Addition**: Fish purchasing/adding should be handled by separate systems (shop, rewards, etc.)

## Performance Considerations

- Set appropriate `maxFishCount` limits
- Use object pooling for fish prefabs if spawning/destroying frequently
- Consider reducing movement update frequency for large numbers of fish
- **Real-time listeners**: More efficient than polling, updates only when data changes
- Automatic listener cleanup prevents memory leaks

## Troubleshooting

1. **Fish not moving**: Check that tankBounds are properly calculated from the FishTank node's UITransform
2. **Fish not spawning**: Ensure fishPrefab has the Fish component and a Sprite component
3. **Database errors**: Verify Firebase authentication and database rules
4. **Fish going outside bounds**: Check the FishTank node's UITransform size and position
5. **Real-time updates not working**: Ensure user is authenticated and `autoLoadFish` is enabled
